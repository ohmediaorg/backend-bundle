<script src="/backend/js/tinymce/tinymce.min.js"></script>

<script async>
function OH_MEDIA_TINYMCE(container, selector) {
  const els = container.querySelectorAll(selector);

  els.forEach(el => {
    el.required = false;

    tinymce.init({
      target: el,
      plugins: {{ plugins|json_encode|raw }},
      toolbar: {{ toolbar|json_encode|raw }},
      license_key: 'gpl',
    });
  });
}

tinymce.PluginManager.add('shortcodes', (editor, url) => {
  const twigOpen = {{ '{{ '|json_encode|raw }};
  const twigClose = {{ ' }}'|json_encode|raw }};

  async function openDialog() {
    let shortcode = null;

    let shortcodes = [];

    const dialogConfig = {
      title: 'Shortcodes',
      buttons: [
        { type: 'cancel', text: 'Close' },
        { type: 'submit', text: 'Insert', buttonType: 'primary' }
      ],
      onTabChange: (api, details) => {
        const data = api.getData();

        shortcode = data[`${details.newTabName}_shortcode`];
      },
      onChange: (api, details) => {
        const data = api.getData();

        shortcode = data[details.name];
      },
      onSubmit: (api) => {
        if (shortcode) {
          editor.insertContent(twigOpen + shortcode + twigClose);
        }

        api.close();
      }
    };

    dialogConfig.body = {
      type: 'panel',
      items: [{
        type: 'alertbanner',
        text: 'Loading shortcodes...',
        level: 'info',
        icon: 'info',
      }]
    };

    const dialog = editor.windowManager.open(dialogConfig);

    try {
      const response = await fetch('{{ path('shortcodes') }}');
      const shortcodes = await response.json();

      dialogConfig.body = {
        type: 'tabpanel',
        tabs: shortcodes
      };

      dialog.redial(dialogConfig);

      shortcode = dialog.getData().tab_0_shortcode;
    } catch {
      dialogConfig.body = {
        type: 'panel',
        items: [{
          type: 'alertbanner',
          text: 'There was an issue loading shortcodes.',
          level: 'warn',
          icon: 'warning',
        }]
      };

      dialog.redial(dialogConfig);
    }
  }

  editor.ui.registry.addButton('shortcodes', {
    name: 'Shortcodes',
    icon: 'code-sample',
    onAction: openDialog,
  });

  editor.ui.registry.addMenuItem('shortcodes', {
    text: 'Shortcodes',
    icon: 'code-sample',
    onAction: openDialog,
  });

  return {
    getMetadata: () => ({
      name: 'Shortcodes',
      url: 'mailto:support@ohmedia.ca',
    })
  };
});

document.addEventListener('DOMContentLoaded', function() {
  OH_MEDIA_TINYMCE(document, 'textarea.wysiwyg');

  const observer = new MutationObserver(function(mutationList, observer) {
    for (const mutation of mutationList) {
      if ('childList' !== mutation.type) {
        continue;
      }

      OH_MEDIA_TINYMCE(mutation.target, 'textarea.wysiwyg');
    }
  });

  observer.observe(document.body, {
    childList: true,
    subtree: true,
  });
});
</script>
